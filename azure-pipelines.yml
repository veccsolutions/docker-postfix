name: 1.0.$(rev:r)

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: Docker@2
  displayName: Login
  inputs:
    containerRegistry: 'Harbor-Vecc-Docker'
    command: 'login'
- task: CmdLine@2
  displayName: Build
  inputs:
    script: |
      docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
      docker buildx create --name multiarch --driver docker-container --use
      docker buildx build --platform linux/amd64,linux/arm64 \
        -t harbor.veccsolutions.org/vecc/postfix:$(build.buildNumber) \
        -t harbor.veccsolutions.org/vecc/postfix:latest \
        --push \
        .
